{


    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description":"VPC with 2 subnets, 1 EC2 and 1 RDS",
    "Parameters":{

        
        "as": {
            "Description": "allocated storage in GB",
            "Type": "String",
            "Default": "20"
        },   
        "mydbinstanceclass": {
            "Description": "db instance class",
            "Type": "String",
            "Default": "db.t2.micro"
        },
        
        "mydbname": {
            "Description": "db name",
            "MinLength":"4",
            "MaxLength":"10",
            "Type": "String"
            
        },
        "mydbusername":{
            "Description": "db username",
            "MinLength":"4",
            "MaxLength":"8",
            "Type": "String"
        },
        "mydbpassword":{

            "Description": "db username",
            "MinLength":"8",
            "MaxLength":"16",
            "Type": "String"

        },
        "cidrvpc": {
            "Description": "cidr of vpc",
            "Type": "String",
            "Default": "10.10.0.0/16"
        },
        "cidrsub1": {
            "Description": "cidr of subnet 1",
            "Type": "String",
            "Default": "10.10.1.0/24"
        },
        "cidrsub2": {
            "Description": "cidr of subnet 2",
            "Type": "String",
            "Default": "10.10.2.0/24"
        },
        
        "azsub1": {
            "Description": "az for subnet 1",
            "Type": "AWS::EC2::AvailabilityZone::Name"
        },
        "azsub2": {
            "Description": "az for subnet 2",
            "Type": "AWS::EC2::AvailabilityZone::Name"
        },
       
        "myinstancetype" : {
            "Description" : "EC2 instance type",
            "Type" : "String",
            "Default" : "t2.micro",
            "AllowedValues" : [ "t1.micro","t2.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","m3.xlarge","m3.2xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"]
        },
           
    
        "mykeypair": {
            "Description": "Keypair for EC2 Instance",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
    
        "myaz": {
            "Description": "AZ for EC2 Instance",
            "Type": "AWS::EC2::AvailabilityZone::Name"
        }       
    },
    "Mappings":{
        
        "RegionMap": {"us-east-1": {"AMI": "ami-011b3ccf1bd6db744"},
                      "us-east-2": {"AMI": "ami-03291866"},
                      "us-west-1": {"AMI": "ami-18726478"},
                      "us-west-2": {"AMI": "ami-28e07e50"},
                      "ap-south-1": {"AMI": " ami-5b673c34"},
                      "ap-northeast-2": {"AMI": "ami-3eee4150"},
                      "ap-southeast-1": {"AMI": "ami-76144b0a"},
                      "ap-southeast-2": {"AMI": "ami-67589505"},
                      "ap-northeast-1": {"AMI": "ami-08419d23bf91152e4"},
                      "ca-central-1": {"AMI": "ami-49f0762d"},
                      "eu-central-1": {"AMI": "ami-c86c3f23"},
                      "eu-west-1": {"AMI": "ami-7c491f05"},
                      "eu-west-2": {"AMI": "ami-7c1bfd1b"},
                      "eu-west-3": {"AMI": "ami-5026902d"},
                      "sa-east-1": {"AMI": "ami-b0b7e3dc"}
                     }
                     
     },


    "Resources":{
        "myvpc": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
              "CidrBlock": { "Ref": "cidrvpc" }
            }
          },
          
          "sub1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
              "AvailabilityZone": { "Ref": "azsub1" },
              "VpcId": { "Ref": "myvpc" },
              "CidrBlock": { "Ref": "cidrsub1" }
            }
          },
          "sub2": {
              "Type": "AWS::EC2::Subnet",
              "Properties": {
                "AvailabilityZone": { "Ref": "azsub2" },
                "VpcId": { "Ref": "myvpc" },
                "CidrBlock": { "Ref": "cidrsub2" }
              }
            },
            
          
          "mysecuritygroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
              "GroupDescription" : "Allow SSH",
              "SecurityGroupIngress" : [
                  {
                      "IpProtocol" : "tcp",
                      "FromPort" : 22,
                      "ToPort" : 22,
                      "CidrIp" : "0.0.0.0/0"
                   }
          
              ],
              "VpcId" : { "Ref": "myvpc" }
            }
          },
         
  
          "myec2instance": {
              "Type": "AWS::EC2::Instance",
              "Properties": {
                  "KeyName": { "Ref": "mykeypair" },
                  "ImageId":{ "Fn::FindInMap": ["RegionMap",{ "Ref": "AWS::Region" },"AMI"]},
                  "InstanceType": { "Ref": "myinstancetype" },
                  "AvailabilityZone" : { "Ref": "myaz" },
                  "SecurityGroupIds" : [{ "Ref": "mysecuritygroup" }],
                  "SubnetId" : { "Ref": "sub2" },
                   "Tags":[{ "Key": "Name", "Value":  "EC2Instance" }]  
              }
          
          },

          "dbsubgrp": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
               "SubnetIds": [ { "Ref": "sub1" }]
            }
         },
          "dbsg": {
            "Type": "AWS::RDS::DBSecurityGroup",
            "Properties": {
               "EC2VpcId":  { "Ref": "myvpc" },
               "DBSecurityGroupIngress":  [{ 
                    "EC2SecurityGroupName": { "Ref": "mysecuritygroup" },
                    "EC2SecurityGroupId": { "Ref": "mysecuritygroup" },
                    "CIDRIP":"10.10.0.0/32"
                   }],
               "GroupDescription": "database security group"   
                }  
            },      
        
        "myrds": {
          "Type": "AWS::RDS::DBInstance",
          "Properties": {
            "AllocatedStorage": { "Ref": "as" },
            "DBInstanceClass": { "Ref": "mydbinstanceclass" },
            "DBInstanceIdentifier": "lokesh-rds",
            "DBName": { "Ref": "mydbname" },
            "Engine": "MySQL",
            "EngineVersion": "5.6.40",    
            "MasterUsername": { "Ref": "mydbusername" },
            "MasterUserPassword": { "Ref": "mydbpassword" },
            "Tags" :[{"Key" :"Name","Value" :"My SQL Database" }],
            "DBSecurityGroups" : { "Ref": "dbsg" },
            "DBSubnetGroupName" : { "Ref": "dbsubgrp" }    
            }
            }
    }
}
